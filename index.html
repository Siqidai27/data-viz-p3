<!DOCTYPE html>
<html lang="en">
<head>
    <title>Global Terrorism</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<!-- <script src="http://d3js.org/topojson.v2.min.js"></script> -->
	<script src="scripts/d3-tip.js"></script>
    <script src="https://unpkg.com/topojson-client@2"></script>
    <script src="scripts/versor.js"></script>
    <script src="scripts/d3.slider.js"></script>
</head>
<style>
    .d3-tip {
        line-height: 1;
        padding: 6px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 4px;
        font-size: 12px;
    }
    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
    }

    /* Style northward tooltips specifically */
    .d3-tip.n:after {
        margin: -2px 0 0 0;
        top: 100%;
        left: 0;
    }

    #background {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0px;
        top: 0px;
        z-index: 0;
    }
    .titleFont {
        position: absolute;
        top: 420px;
        /*bottom: 40px;*/
        right: 20px;
        font-family: "Georgia";
        font-size: 80px;
        color: white;
    }
    .secondaryFont{
        position: absolute;
        top: 500px;
        /*bottom: 40px;*/
        right: 20px;
        font-family: "Georgia";
        font-size: 50px;
        color: white;
    }
    .img {
        width: 100%;
        height: auto;
        opacity: 0.9;
        background-size: cover;
    }

    #selectYear {
         position: absolute;
         left: 60px;
         top: 0px;
         font-family: "arial"
    }

    select {
        position: absolute;
        top: 50px;
        left: 60px;
        border: solid #ccc 1px;
        padding: 3px;
        box-shadow: inset 1px 1px 2px #ddd8dc;
        width: 200px;
    }

    .countryTooltip {
        position: absolute;
        display: none;
        pointer-events: none;
        background: #fff;
        padding: 5px;
        text-align: left;
        border: solid #ccc 1px;
        color: #666;
        font-size: 14px;
        font-family: sans-serif;
    }

    .back {
        fill: lightgray;
        stroke: gray;
        stroke-width: 1px;
    }
    .gridback {
        fill: none;
        stroke: darkgrey;
        stroke-width: 1px;
    }
    .front {
        fill: pink;
        stroke: red;
        stroke-width: 1px;
    }
    .gridfront {
        fill: none;
        stroke: darkgreen;
        stroke-width: 1px;
    }
    .focused {
        fill: #87BCDE;
    }

</style>
<body>
	<!-- <div class="background">
	    <img class="img" src="image/terrorism_bg1.jpg" >
	    <div class="titleFont"></div>
		<div class="secondaryFont"></div>
	</div> -->
    <div id="selectYear">
        <label for="year"
            style="display: inline-block; text-align: left; width: 200px; height: 0px; color: black">
            year: <span id="year-value"></span>
        </label>
        <input id="year" type="range" min="1970" max="2015" step="1" value="2015">
    </div>
<script>
// SELECT COUNTRY
    var countryTooltip = d3.select("body").append("div").attr("class", "countryTooltip"),
    countryList = d3.select("body").append("select").attr("name", "countries");


// SELECT YEAR
    var yearSelected=2015;
    d3.select("#year-value").text(yearSelected);
    d3.select("#year").on("input", function(){
        yearSelected = this.value;
        d3.selectAll("circle").remove();
        d3.select("#year-value").text(yearSelected);
        if (focusedCountry) {showLocation();}
    })


// create svg for globe
    var width = 1000, height = 1000;
    var focused, countries, terrorismData=[], focusedCountry, terrorisms;
    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);


// !!!DRAW GLOBE!!!
    var projection = d3.geoOrthographic()
    .scale(350)
    .rotate([0, 0])
    .translate([width / 2 - 100, height / 2]);
    var path = d3.geoPath().projection(projection);
    var graticule = d3.geoGraticule();
    var grid = graticule();
    var g = svg.append("g");

    function showGlobe() {
        svg.selectAll("path").remove();

        // draw back of the globe
        projection.clipAngle(180);
        var worldBack = g.selectAll("path.back")
        .data(countries).enter().append("path")
        .attr("class", "back")
        .attr("d", path);
        var gridBack = g.selectAll("path.gridback")
        .data([grid]).enter().append("path")
        .attr("class", "gridback")
        .attr("d", path);

        // draw front of the globe
        projection.clipAngle(90);
        var worldFront = g.selectAll("path.front")
        .data(countries).enter().append("path")
        .attr("class", "front")
        .attr("d", path);
        var gridFront = g.selectAll("path.gridfront")
        .data([grid]).enter().append("path")
        .attr("class", "gridfront")
        .attr("d", path);
    };


// highlight focusedCountry
    function highlightCountry() {
        svg.selectAll("path").classed("focused", function(d, i) {
            return d.id == focusedCountry.id ? focused = d : false;
        });
    };


// !!!SHOW TERRORISM LOCATIONS!!!
    function showLocation() {
        svg.selectAll("circle").remove();
        allData[focusedCountry.id].forEach( function(d) {
            d[yearSelected].forEach( function(e) {
                g.append("circle")
                .attr("cx", projection(e.location)[0])
                .attr("cy", projection(e.location)[1])
                .attr("r", 5)
                .style("fill", "red");
            });
        });
    };


// !!!DRAG GLOBE FUNCTION!!!
    svg.call(d3.drag().on("start", dragstarted).on("drag", dragged));

    var v0, // Mouse position in Cartesian coordinates at start of drag gesture.
    r0, // Projection rotation as Euler angles at start.
    q0; // Projection rotation as versor at start.

    function dragstarted() {
        v0 = versor.cartesian(projection.invert(d3.mouse(this)));
        r0 = projection.rotate();
        q0 = versor(r0);
    };

    function dragged() {
        var v1 = versor.cartesian(projection.rotate(r0).invert(d3.mouse(this))),
            q1 = versor.multiply(q0, versor.delta(v0, v1)),
            r1 = versor.rotation(q1);
        projection.rotate(r1);
        showGlobe();
        highlightCountry();
        if (focusedCountry) {showLocation();}
    };


// !!!GLOBE ROTATION -> FOCUSEDCOUNTRY!!!
    d3.select("select").on("change", function() {
        var rotate = projection.rotate();

        for (var i = 0; i < countries.length; i++) {
            if(countries[i].id == this.value) {focusedCountry = countries[i];}
        };

        var p = d3.geoCentroid(focusedCountry);

        svg.selectAll(".focused").classed("focused", focused = false);

        (function transition() {
            d3.transition()
            .duration(2500)
            .tween("rotate", function() {
                var r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
                return function(t) {
                    projection.rotate(r(t));
                    showGlobe();
                    highlightCountry();
                    showLocation();
                };
            });
        })();
    });


    var countryKey = []
    var allData = []
    // var yearData=[];

    function parseAllData(line){
      countryKey[line.Country_ID]=[];
      allData[line.Country_ID]=[];
      return line;
    }


// !!!LOAD DATA!!!
    d3.queue()
    .defer(d3.json, "data/world-110m.json")
    .defer(d3.tsv, "data/world-110m-country-names.tsv")
    .defer(d3.csv, "data/globalterrorism_new.csv",parseAllData)
    .await(function(error, world, countryNames, rawTerrorism) {
        if (error) throw error;

        // world data
        countries = topojson.feature(world, world.objects.countries).features;

        // country name data
        var countryById = {};
        countryNames.forEach(function(d) {
            countryById[d.id] = d.name;
            option = countryList.append("option");
            option.text(d.name);
            option.property("value", d.id);
        });

        // terrorism data
        var terrorism = rawTerrorism;

        var tempData=[]

        terrorism.forEach(function(d,i){
            terrorism[i]["location"]=[d.longitude,d.latitude];
        })

        terrorism.forEach(function(d){
          var value = d;
          countryKey[d.Country_ID].push(value);
        })

        var yearData = [];

        countryKey.forEach(function(d,i){
          yearData = [];
          for(var j=0;j<d.length;j++){
            yearData[d[j].iyear]=[];
          }
          d.forEach(function(v){
            var value = v;
            yearData[v.iyear].push(value);
          })
          allData[i].push(yearData);
        })

        var nestedTerrorism = d3.nest()
        .key(function(d){ return d.Country_ID; })
        .key(function(d){ return d.iyear; })
        .rollup(function(v){ return v;})
        .entries(terrorism)

        // call render function to draw globe
        showGlobe();
    });
</script>

</body>
</html>
