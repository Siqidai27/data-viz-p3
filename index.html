<!DOCTYPE html>
<html lang="en">
<head>
    <title>Global Terrorism</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<!-- <script src="http://d3js.org/topojson.v2.min.js"></script> -->
	<script src="scripts/d3-tip.js"></script>
    <script src="https://unpkg.com/topojson-client@2"></script>
    <script src="scripts/versor.js"></script>
</head>
<style>
    .d3-tip {
        line-height: 1;
        padding: 6px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 4px;
        font-size: 12px;
    }
    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
    }

    /* Style northward tooltips specifically */
    .d3-tip.n:after {
        margin: -2px 0 0 0;
        top: 100%;
        left: 0;
    }

    #background {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0px;
        top: 0px;
        z-index: 0;
    }
    .titleFont {
        position: absolute;
        top: 420px;
        /*bottom: 40px;*/
        right: 20px;
        font-family: "Georgia";
        font-size: 80px;
        color: white;
    }
    .secondaryFont{
        position: absolute;
        top: 500px;
        /*bottom: 40px;*/
        right: 20px;
        font-family: "Georgia";
        font-size: 50px;
        color: white;
    }
    .img {
        width: 100%;
        height: auto;
        opacity: 0.9;
        background-size: cover;
    }
    .focused {
      fill: #87BCDE;
    }
    select {
      position: absolute;
      top: 900px;
      left: 60px;
      border: solid #ccc 1px;
      padding: 3px;
      box-shadow: inset 1px 1px 2px #ddd8dc;
      width: 200px;
    }

    .countryTooltip {
        position: absolute;
        display: none;
        pointer-events: none;
        background: #fff;
        padding: 5px;
        text-align: left;
        border: solid #ccc 1px;
        color: #666;
        font-size: 14px;
        font-family: sans-serif;
    }

</style>
<body>
	<div class="background">
	    <img class="img" src="image/terrorism_bg1.jpg" >
	    <div class="titleFont"></div>
		<div class="secondaryFont"></div>
	</div>
<script>
    var countryTooltip = d3.select("body").append("div").attr("class", "countryTooltip"),
    countryList = d3.select("body").append("select").attr("name", "countries");

    var width = 1000, height = 1000, focused;

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

    var projection = d3.geoOrthographic()
    .scale(350)
    .rotate([0, 0])
    .translate([width / 2 - 100, height / 2]);

    var path = d3.geoPath().projection(projection);

    var graticule = d3.geoGraticule();

    // svg.call(d3.zoom().scaleExtent([1/2, 16]).on("zoom", function() {
    //     g.attr("transform", d3.event.transform);
    // }));

    svg.call(d3.drag().on("start", dragstarted).on("drag", dragged));

    var render = function() {},
    v0, // Mouse position in Cartesian coordinates at start of drag gesture.
    r0, // Projection rotation as Euler angles at start.
    q0; // Projection rotation as versor at start.

    function dragstarted() {
        v0 = versor.cartesian(projection.invert(d3.mouse(this)));
        r0 = projection.rotate();
        q0 = versor(r0);
    }

    function dragged() {
        var v1 = versor.cartesian(projection.rotate(r0).invert(d3.mouse(this))),
            q1 = versor.multiply(q0, versor.delta(v0, v1)),
            r1 = versor.rotation(q1);
        projection.rotate(r1);
        render();
    }

	var g = svg.append("g");
    // var countries;

    d3.queue()
    .defer(d3.json, "data/world-110m.json")
    .defer(d3.tsv, "data/world-110m-country-names.tsv")
    .await(function(error, world, countryNames) {
        if (error) throw error;

        var countries = topojson.feature(world, world.objects.countries).features;
        console.log(countries)
        var grid = graticule();

        var countryById = {};

        countryNames.forEach(function(d) {
          countryById[d.id] = d.name;
          option = countryList.append("option");
          option.text(d.name);
          option.property("value", d.id);
        });
        console.log(countryNames)

        render = function() {
            svg.selectAll("path").remove();

            projection.clipAngle(180);

            var worldBack = g.selectAll("path.back")
            .data(countries)
            .enter().append("path")
            .attr("class", "back")
            .attr("d", path)
            .style("fill", "lightgray")
            .style("stroke", "gray")
            .style("stroke-width", "1px");

            var gridBack = g.selectAll("path.gridback")
            .data([grid])
            .enter()
            .append("path")
            .attr("class", "gridback")
            .attr("d", path)
            .style("fill", "none")
            .style("stroke", "darkgrey")
            .style("stroke-width", "1px");

            projection.clipAngle(90);

            var worldFore = g.selectAll("path.front")
            .data(countries)
            .enter()
            .append("path")
            .attr("class", "front")
            .attr("d", path)
            .style("fill", "pink")
            .style("stroke", "red")
            .style("stroke-width", "1px");

            var gridFore = g.selectAll("path.gridfront")
            .data([grid])
            .enter()
            .append("path")
            .attr("class", "gridfront")
            .attr("d", path)
            .style("fill", "none")
            .style("stroke", "darkgreen")
            .style("stroke-width", "1px");

        };

        render();

        d3.select("select").on("change", function() {
            var rotate = projection.rotate(),
            focusedCountry = country(countries, this);
            var p = d3.geoCentroid(focusedCountry);
            svg.selectAll(".focused").classed("focused", focused = false);

            (function transition() {
                d3.transition()
                .duration(2500)
                .tween("rotate", function() {
                    var r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
                    return function(t) {
                        projection.rotate(r(t));
                        render();
                        // svg.selectAll("path").attr("d", path)
                        // .classed("focused", function(d, i) {
                        //     // console.log(d)
                        //     return d.id == focusedCountry.id ? focused = d : false; });
                    };
                });
            })();
        });
        function country(cnt, sel) {
            for(var i = 0, l = cnt.length; i < l; i++) {
                console.log(cnt[i].id)
                console.log(sel.value)
                if(cnt[i].id == sel.value) {
                    return cnt[i];}
            }
        };
    });




</script>

</body>
</html>
